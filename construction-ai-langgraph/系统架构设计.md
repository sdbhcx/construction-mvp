# ğŸ—ï¸ æ–½å·¥è®°å½•æ™ºèƒ½è¯†åˆ«ç³»ç»Ÿ - ç³»ç»Ÿæ¶æ„è®¾è®¡

## 1. æ¶æ„æ€»è§ˆ

### 1.1 æ¶æ„ç›®æ ‡

* **é«˜å¯ç”¨æ€§** ï¼š99.5%ç³»ç»Ÿå¯ç”¨æ€§
* **å¯æ‰©å±•æ€§** ï¼šæ”¯æŒæ°´å¹³æ‰©å±•ï¼Œåº”å¯¹ä¸šåŠ¡å¢é•¿
* **å¯ç»´æŠ¤æ€§** ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºå‡çº§ç»´æŠ¤
* **å®‰å…¨æ€§** ï¼šå¤šå±‚æ¬¡å®‰å…¨é˜²æŠ¤ï¼Œæ•°æ®éšç§ä¿æŠ¤
* **æ€§èƒ½** ï¼šå•å¼ å¤„ç†â‰¤30ç§’ï¼Œæ”¯æŒå¹¶å‘å¤„ç†

### 1.2 æ¶æ„åŸåˆ™

1. **å¾®æœåŠ¡åŒ–** ï¼šä¸šåŠ¡åŠŸèƒ½è§£è€¦ï¼Œç‹¬ç«‹éƒ¨ç½²
2. **äº‹ä»¶é©±åŠ¨** ï¼šå¼‚æ­¥å¤„ç†ï¼Œæé«˜ååé‡
3. **æ•°æ®é©±åŠ¨** ï¼šåŸºäºæ•°æ®åé¦ˆæŒç»­ä¼˜åŒ–
4. **DevOps** ï¼šCI/CDè‡ªåŠ¨åŒ–ï¼Œå¿«é€Ÿè¿­ä»£

## 2.æ€»ä½“æ¶æ„å›¾

![1768467455446](image/ç³»ç»Ÿæ¶æ„è®¾è®¡/1768467455446.png)

## 3. è¯¦ç»†æ¶æ„è®¾è®¡

### 3.1 å®¢æˆ·ç«¯å±‚

#### 3.1.1 Webå‰ç«¯

```javascript
// æŠ€æœ¯æ ˆ
å‰ç«¯æ¡†æ¶: React 18 + TypeScript
UIåº“: Ant Design 5.0
çŠ¶æ€ç®¡ç†: Zustand
è·¯ç”±: React Router 6
æ„å»ºå·¥å…·: Vite
åŒ…ç®¡ç†: pnpm

// æ¨¡å—åˆ’åˆ†
src/
â”œâ”€â”€ pages/           // é¡µé¢ç»„ä»¶
â”‚   â”œâ”€â”€ Upload/     // ä¸Šä¼ é¡µé¢
â”‚   â”œâ”€â”€ Review/     // å¤æ ¸é¡µé¢
â”‚   â”œâ”€â”€ Dashboard/  // æ•°æ®çœ‹æ¿
â”‚   â”œâ”€â”€ Query/      // æ™ºèƒ½æŸ¥è¯¢é¡µé¢
â”‚   â””â”€â”€ Admin/      // ç®¡ç†åå°
â”œâ”€â”€ components/      // é€šç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ Layout/     // å¸ƒå±€ç»„ä»¶
â”‚   â”œâ”€â”€ ReviewPanel/ // å¤æ ¸é¢æ¿
â”‚   â”œâ”€â”€ FileList/   // æ–‡ä»¶åˆ—è¡¨
â”‚   â””â”€â”€ ChatBox/    // èŠå¤©æ¡†
â”œâ”€â”€ services/       // APIæœåŠ¡
â”‚   â”œâ”€â”€ auth.ts     // è®¤è¯æœåŠ¡
â”‚   â”œâ”€â”€ upload.ts   // ä¸Šä¼ æœåŠ¡
â”‚   â”œâ”€â”€ review.ts   // å¤æ ¸æœåŠ¡
â”‚   â””â”€â”€ query.ts    // æŸ¥è¯¢æœåŠ¡
â”œâ”€â”€ stores/         // çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ user.ts     // ç”¨æˆ·çŠ¶æ€
â”‚   â”œâ”€â”€ task.ts     // ä»»åŠ¡çŠ¶æ€
â”‚   â””â”€â”€ config.ts   // é…ç½®çŠ¶æ€
â””â”€â”€ utils/          // å·¥å…·å‡½æ•°
```

#### 3.1.2 ç§»åŠ¨ç«¯

```javascript
// æŠ€æœ¯æ ˆ
æ¡†æ¶: React Native / Flutter
UIåº“: Ant Design Mobile / Flutter SDK
çŠ¶æ€ç®¡ç†: Provider / GetX
æ‰“åŒ…: iOS/AndroidåŒå¹³å°

// æ ¸å¿ƒåŠŸèƒ½
1. æ‹ç…§ä¸Šä¼ 
2. ç¦»çº¿ç¼“å­˜
3. æ¶ˆæ¯æ¨é€
4. æ‰«ç è¯†åˆ«
5. è¯­éŸ³æŸ¥è¯¢
```

### 3.2 æ¥å…¥å±‚

#### 3.2.1 APIç½‘å…³ (Kong)

```yaml
# Kongé…ç½®ç¤ºä¾‹
services:
  - name: upload-service
    url: http://upload-service:8001
    routes:
      - name: upload-route
        paths: ["/api/v1/upload"]
        methods: ["POST"]
      
  - name: review-service
    url: http://review-service:8002
    routes:
      - name: review-route
        paths: ["/api/v1/review"]
        methods: ["GET", "POST", "PUT"]
  
  - name: query-service
    url: http://query-service:8003
    routes:
      - name: query-route
        paths: ["/api/v1/query"]
        methods: ["POST"]

plugins:
  - name: rate-limiting
    config:
      minute: 100  # æ¯åˆ†é’Ÿ100æ¬¡
      policy: local
    
  - name: jwt
    config:
      secret: ${JWT_SECRET}
      claims_to_verify: ["exp", "iss"]
```

#### 3.2.2 è´Ÿè½½å‡è¡¡ (Nginx)

```nginx
# Nginxé…ç½®
upstream backend {
    server backend1:8000 weight=3;
    server backend2:8000 weight=3;
    server backend3:8000 weight=4;
  
    # å¥åº·æ£€æŸ¥
    check interval=3000 rise=2 fall=3 timeout=1000;
}

server {
    listen 443 ssl;
    server_name construction-ai.com;
  
    ssl_certificate /etc/ssl/cert.pem;
    ssl_certificate_key /etc/ssl/key.pem;
  
    location /api/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
      
        # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
        client_max_body_size 100M;
      
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

### 3.3 åº”ç”¨å±‚

#### 3.3.1 å¾®æœåŠ¡æ¶æ„

```yaml
# æœåŠ¡æ¸…å•
services:
  auth-service:      # è®¤è¯æœåŠ¡
    port: 8001
    dependencies: [postgres, redis]
    health: /health
  
  upload-service:    # ä¸Šä¼ æœåŠ¡
    port: 8002
    dependencies: [minio, rabbitmq]
    health: /health
  
  review-service:    # å¤æ ¸æœåŠ¡
    port: 8003
    dependencies: [postgres, redis, rabbitmq]
    health: /health
  
  query-service:      # æŸ¥è¯¢æœåŠ¡
    port: 8004
    dependencies: [postgres, redis, rabbitmq, vector_db]
    health: /health
  
  dashboard-service: # çœ‹æ¿æœåŠ¡
    port: 8005
    dependencies: [postgres, elasticsearch]
    health: /health
  
  ai-orchestrator:   # AIè°ƒåº¦æœåŠ¡
    port: 8006
    dependencies: [redis, rabbitmq, ai-services]
    health: /health
```

#### 3.3.2 æ™ºèƒ½ä½“æ¶æ„ (LangGraph)

```python
# æ™ºèƒ½ä½“ç¼–æ’
class ConstructionAgentSystem:
    """æ–½å·¥è®°å½•æ™ºèƒ½ä½“ç³»ç»Ÿ"""
  
    def __init__(self):
        # æ™ºèƒ½ä½“æ³¨å†Œè¡¨
        self.agents = {
            'orchestrator': OrchestratorAgent(),
            'information_extraction': InformationExtractionAgent(),
            'qa_query': QAQueryAgent()
        }
      
        # å·¥ä½œæµå¼•æ“
        self.workflow = LangGraphWorkflow()
      
    async def process_document(self, document):
        """å¤„ç†æ–‡æ¡£å·¥ä½œæµ - åœºæ™¯ä¸€"""
        # 1. æ™ºèƒ½è°ƒåº¦
        task = await self.agents['orchestrator'].route_document(document)
      
        # 2. ä¿¡æ¯æŠ½å–
        if task.type == 'extraction':
            extracted = await self.agents['information_extraction'].process(document)
            return extracted
      
    async def process_query(self, query):
        """å¤„ç†æŸ¥è¯¢å·¥ä½œæµ - åœºæ™¯äºŒ"""
        # 1. æ™ºèƒ½è°ƒåº¦
        task = await self.agents['orchestrator'].route_query(query)
      
        # 2. é—®ç­”æŸ¥è¯¢
        if task.type == 'query':
            result = await self.agents['qa_query'].process(query)
            return result

# ä¿¡æ¯æŠ½å–æ™ºèƒ½ä½“
class InformationExtractionAgent:
    """ä¿¡æ¯æŠ½å–æ™ºèƒ½ä½“"""
  
    async def process(self, document):
        """æ‰§è¡Œä¿¡æ¯æŠ½å–æµç¨‹"""
        # Step 1: OCRè¯†åˆ«
        ocr_result = await self._ocr_node(document)
      
        # Step 2: é¢†åŸŸNER
        ner_result = await self._ner_node(ocr_result)
      
        # Step 3: VLMç²¾ç‚¼
        vlm_result = await self._vlm_node(document, ner_result)
      
        # Step 4: æ•°æ®å­˜å‚¨
        await self._storage_node(vlm_result)
      
        # Step 5: äººå·¥å¤æ ¸
        await self._review_node(vlm_result)
      
        return vlm_result

# é—®ç­”ä¸æŸ¥è¯¢æ™ºèƒ½ä½“
class QAQueryAgent:
    """é—®ç­”ä¸æŸ¥è¯¢æ™ºèƒ½ä½“"""
  
    async def process(self, query):
        """æ‰§è¡Œé—®ç­”æŸ¥è¯¢æµç¨‹"""
        # Step 1: æ„å›¾è¯†åˆ«ä¸å·¥å…·è§„åˆ’
        intent = await self._intent_recognition_node(query)
      
        # Step 2: SQLæŸ¥è¯¢
        if intent.needs_sql:
            sql_result = await self._sql_query_node(intent)
        else:
            sql_result = None
      
        # Step 3: å‘é‡æ£€ç´¢
        if intent.needs_vector_search:
            vector_result = await self._vector_search_node(query)
        else:
            vector_result = None
      
        # Step 4: ç­”æ¡ˆåˆæˆ
        answer = await self._answer_synthesis_node(query, sql_result, vector_result)
      
        return answer
```

### 3.4 èƒ½åŠ›å±‚

#### 3.4.1 AIæœåŠ¡æ¶æ„

```python
# AIæœåŠ¡å®¹å™¨åŒ–éƒ¨ç½²
# docker-compose-ai.yml
version: '3.8'

services:
  # OCRæœåŠ¡
  ocr-service:
    image: paddleocr:latest
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - GPU_ID=0
      - BATCH_SIZE=16
    ports:
      - "8007:8000"
    
  # VLMæœåŠ¡
  vlm-service:
    image: qwen-vl:latest
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 2
              capabilities: [gpu]
    environment:
      - MODEL_PATH=/models/qwen-vl
      - DEVICE=cuda:0,1
    ports:
      - "8008:8000"
    
  # NERæœåŠ¡
  ner-service:
    image: construction-ner:latest
    build:
      context: ./models/ner
      dockerfile: Dockerfile
    ports:
      - "8009:8000"
    
  # LLMæœåŠ¡
  llm-service:
    image: qwen-72b:latest
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 4
              capabilities: [gpu]
    environment:
      - MODEL_PATH=/models/qwen-72b
      - DEVICE=cuda:0,1,2,3
    ports:
      - "8010:8000"
    
  # æ¨¡å‹ç½‘å…³
  model-gateway:
    image: nginx:alpine
    ports:
      - "8011:80"
    volumes:
      - ./configs/model-gateway.conf:/etc/nginx/nginx.conf
```

#### 3.4.2 æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡

```python
# RabbitMQé˜Ÿåˆ—è®¾è®¡
QUEUES = {
    # ä¸Šä¼ é˜Ÿåˆ—
    'upload_queue': {
        'name': 'document.upload',
        'durable': True,
        'arguments': {'x-max-priority': 10}
    },
  
    # OCRé˜Ÿåˆ—
    'ocr_queue': {
        'name': 'ai.ocr',
        'durable': True,
        'arguments': {'x-max-priority': 5}
    },
  
    # VLMé˜Ÿåˆ—
    'vlm_queue': {
        'name': 'ai.vlm',
        'durable': True,
        'arguments': {'x-max-priority': 8}
    },
  
    # æŸ¥è¯¢é˜Ÿåˆ—
    'query_queue': {
        'name': 'ai.query',
        'durable': True,
        'arguments': {'x-max-priority': 7}
    },
  
    # å¤æ ¸é˜Ÿåˆ—
    'review_queue': {
        'name': 'task.review',
        'durable': True,
        'arguments': {'x-max-priority': 3}
    },
  
    # æ­»ä¿¡é˜Ÿåˆ—
    'dlq': {
        'name': 'dead.letter',
        'durable': True
    }
}

# æ¶ˆæ¯æ ¼å¼
class ProcessingMessage(BaseModel):
    message_id: str
    document_id: str
    task_type: str  # 'upload', 'ocr', 'vlm', 'query', 'review'
    priority: int = 5
    payload: Dict
    created_at: datetime
    retry_count: int = 0
```

### 3.5 æ•°æ®å±‚

#### 3.5.1 æ•°æ®åº“è®¾è®¡

```sql
-- æ ¸å¿ƒè¡¨ç»“æ„
-- 1. ç”¨æˆ·è¡¨
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20),
    role VARCHAR(20) NOT NULL,  -- admin, manager, engineer
    project_ids JSONB,          -- è´Ÿè´£çš„é¡¹ç›®IDåˆ—è¡¨
    settings JSONB,             -- ç”¨æˆ·è®¾ç½®
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 2. é¡¹ç›®è¡¨
CREATE TABLE projects (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    code VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    manager_id INTEGER REFERENCES users(id),
    status VARCHAR(20) DEFAULT 'active',
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 3. æ–‡æ¡£è¡¨
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    file_hash VARCHAR(64) UNIQUE NOT NULL,
    original_name VARCHAR(255),
    file_path VARCHAR(500),
    file_type VARCHAR(20),
    file_size BIGINT,
    uploader_id INTEGER REFERENCES users(id),
    project_id INTEGER REFERENCES projects(id),
    status VARCHAR(20) DEFAULT 'uploaded',  -- uploaded, processing, completed, error
    created_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_status (status),
    INDEX idx_project (project_id)
);

-- 4. å¤„ç†ä»»åŠ¡è¡¨
CREATE TABLE processing_tasks (
    id SERIAL PRIMARY KEY,
    document_id INTEGER REFERENCES documents(id),
    task_type VARCHAR(20) NOT NULL,  -- ocr, vlm, ner, validation
    status VARCHAR(20) DEFAULT 'pending',  -- pending, processing, completed, failed
    input_data JSONB,
    output_data JSONB,
    error_message TEXT,
    processing_time FLOAT,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_document (document_id),
    INDEX idx_status_type (status, task_type)
);

-- 5. æå–ç»“æœè¡¨
CREATE TABLE extraction_results (
    id SERIAL PRIMARY KEY,
    document_id INTEGER REFERENCES documents(id),
    version INTEGER DEFAULT 1,
    extracted_data JSONB NOT NULL,
    confidence_scores JSONB,
    reviewed_by INTEGER REFERENCES users(id),
    review_status VARCHAR(20) DEFAULT 'pending',  -- pending, approved, rejected
    review_notes TEXT,
    reviewed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_document_version (document_id, version),
    INDEX idx_review_status (review_status)
);

-- 6. æ–½å·¥è®°å½•è¡¨ï¼ˆç»“æ„åŒ–æ•°æ®ï¼‰
CREATE TABLE construction_records (
    id SERIAL PRIMARY KEY,
    project_id INTEGER REFERENCES projects(id),
    project_name VARCHAR(100),
    construction_location VARCHAR(200),
    date DATE,
    weather VARCHAR(50),
    work_content TEXT,
    quantity VARCHAR(50),
    unit VARCHAR(20),
    workers TEXT,
    machinery TEXT,
    quality_status VARCHAR(50),
    issues TEXT,
    safety_records TEXT,
    inspector VARCHAR(50),
    supervisor VARCHAR(50),
    document_id INTEGER REFERENCES documents(id),
    created_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_project_date (project_id, date),
    INDEX idx_location (construction_location)
);

-- 7. æŸ¥è¯¢å†å²è¡¨
CREATE TABLE query_history (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    query_text TEXT NOT NULL,
    query_type VARCHAR(20),  -- sql, vector, hybrid
    query_result JSONB,
    response_time FLOAT,
    created_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_user (user_id),
    INDEX idx_created (created_at)
);

-- 8. æ¨¡å‹ç‰ˆæœ¬è¡¨
CREATE TABLE model_versions (
    id SERIAL PRIMARY KEY,
    model_type VARCHAR(20) NOT NULL,  -- ocr, vlm, ner, llm
    version VARCHAR(50) NOT NULL,
    model_path VARCHAR(500),
    performance_metrics JSONB,
    is_active BOOLEAN DEFAULT FALSE,
    deployed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 3.5.2 ç¼“å­˜è®¾è®¡

```python
# Redisç¼“å­˜ç­–ç•¥
class CacheManager:
    """ç¼“å­˜ç®¡ç†"""
  
    def __init__(self):
        self.redis = redis.Redis(
            host=config.REDIS_HOST,
            port=config.REDIS_PORT,
            db=0,
            decode_responses=True
        )
  
    # ç¼“å­˜é”®è®¾è®¡
    CACHE_KEYS = {
        # ç”¨æˆ·ç›¸å…³
        'user:{user_id}': {'ttl': 3600, 'desc': 'ç”¨æˆ·ä¿¡æ¯'},
      
        # æ–‡æ¡£ç›¸å…³
        'document:{doc_id}': {'ttl': 1800, 'desc': 'æ–‡æ¡£ä¿¡æ¯'},
        'document_status:{doc_id}': {'ttl': 300, 'desc': 'æ–‡æ¡£çŠ¶æ€'},
      
        # AIç»“æœç¼“å­˜
        'ocr_result:{file_hash}': {'ttl': 86400, 'desc': 'OCRç»“æœ'},
        'vlm_result:{file_hash}': {'ttl': 86400, 'desc': 'VLMç»“æœ'},
        'query_result:{query_hash}': {'ttl': 3600, 'desc': 'æŸ¥è¯¢ç»“æœ'},
      
        # é…ç½®ç¼“å­˜
        'project_config:{project_id}': {'ttl': 3600, 'desc': 'é¡¹ç›®é…ç½®'},
        'model_config:{model_type}': {'ttl': 1800, 'desc': 'æ¨¡å‹é…ç½®'},
      
        # ä¼šè¯ç¼“å­˜
        'session:{session_id}': {'ttl': 7200, 'desc': 'ç”¨æˆ·ä¼šè¯'},
      
        # é™æµç¼“å­˜
        'rate_limit:{user_id}:{action}': {'ttl': 60, 'desc': 'é™æµè®¡æ•°'}
    }
  
    async def get_with_cache(self, key, func, *args, **kwargs):
        """å¸¦ç¼“å­˜çš„è·å–"""
        # å…ˆæŸ¥ç¼“å­˜
        cached = await self.redis.get(key)
        if cached:
            return json.loads(cached)
      
        # ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡Œå‡½æ•°
        result = await func(*args, **kwargs)
      
        # è®¾ç½®ç¼“å­˜
        ttl = self.CACHE_KEYS.get(key.split(':')[0] + ':*', {}).get('ttl', 300)
        await self.redis.setex(key, ttl, json.dumps(result))
      
        return result
```

### 3.6 éƒ¨ç½²æ¶æ„

#### 3.6.1 Kuberneteséƒ¨ç½²

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: construction-ai-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: construction-ai-api
  template:
    metadata:
      labels:
        app: construction-ai-api
    spec:
      containers:
      - name: api
        image: construction-ai-api:latest
        ports:
        - containerPort: 8000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: url
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5
---
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: construction-ai-service
spec:
  selector:
    app: construction-ai-api
  ports:
  - port: 80
    targetPort: 8000
  type: LoadBalancer
---
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: construction-ai-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - host: construction-ai.com
    http:
      paths:
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: construction-ai-service
            port:
              number: 80
```

#### 3.6.2 ç›‘æ§å‘Šè­¦

```yaml
# prometheusé…ç½®
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'construction-ai-api'
    static_configs:
      - targets: ['construction-ai-api:8000']
    metrics_path: '/metrics'
  
  - job_name: 'ai-services'
    static_configs:
      - targets: ['ocr-service:8007', 'vlm-service:8008', 'ner-service:8009', 'llm-service:8010']
      
  - job_name: 'database'
    static_configs:
      - targets: ['postgres-exporter:9187', 'redis-exporter:9121']

# å‘Šè­¦è§„åˆ™
groups:
  - name: construction-ai-alerts
    rules:
    - alert: HighErrorRate
      expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "é«˜é”™è¯¯ç‡"
        description: "5åˆ†é’Ÿå†…é”™è¯¯ç‡è¶…è¿‡5%"
      
    - alert: HighResponseTime
      expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "é«˜å“åº”æ—¶é—´"
        description: "95%å“åº”æ—¶é—´è¶…è¿‡2ç§’"
      
    - alert: ServiceDown
      expr: up == 0
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "æœåŠ¡å®•æœº"
        description: "{{ $labels.instance }} æœåŠ¡ä¸å¯ç”¨"
```

### 3.7 å®‰å…¨æ¶æ„

#### 3.7.1 å®‰å…¨åˆ†å±‚

```yaml
# å®‰å…¨é˜²æŠ¤å±‚
security_layers:
  # 1. ç½‘ç»œå±‚
  network:
    - WAFé˜²æŠ¤
    - DDoSé˜²æŠ¤
    - ç½‘ç»œéš”ç¦»
  
  # 2. æ¥å…¥å±‚
  access:
    - APIç½‘å…³è®¤è¯
    - é€Ÿç‡é™åˆ¶
    - IPç™½åå•
  
  # 3. åº”ç”¨å±‚
  application:
    - JWTè®¤è¯
    - RBACæˆæƒ
    - è¾“å…¥éªŒè¯
    - SQLé˜²æ³¨å…¥
  
  # 4. æ•°æ®å±‚
  data:
    - æ•°æ®åŠ å¯†ä¼ è¾“
    - æ•°æ®åŠ å¯†å­˜å‚¨
    - æ•°æ®è„±æ•
    - è®¿é—®å®¡è®¡
  
  # 5. è¿ç»´å±‚
  operation:
    - å®‰å…¨æ—¥å¿—
    - æ¼æ´æ‰«æ
    - å…¥ä¾µæ£€æµ‹
    - åº”æ€¥å“åº”
```

#### 3.7.2 è®¤è¯æˆæƒ

```python
# JWTè®¤è¯ä¸­é—´ä»¶
class JWTAuthMiddleware:
    """JWTè®¤è¯ä¸­é—´ä»¶"""
  
    def __init__(self, secret_key: str, algorithm: str = "HS256"):
        self.secret_key = secret_key
        self.algorithm = algorithm
      
    async def __call__(self, request: Request, call_next):
        # è·³è¿‡å…¬å¼€è·¯å¾„
        if request.url.path in ["/api/v1/auth/login", "/health", "/docs"]:
            return await call_next(request)
      
        # è·å–Token
        auth_header = request.headers.get("Authorization")
        if not auth_header or not auth_header.startswith("Bearer "):
            raise HTTPException(status_code=401, detail="æœªæä¾›è®¤è¯Token")
      
        token = auth_header.split(" ")[1]
      
        try:
            # éªŒè¯Token
            payload = jwt.decode(
                token, 
                self.secret_key, 
                algorithms=[self.algorithm]
            )
          
            # æ£€æŸ¥æƒé™
            if not self._check_permission(payload, request):
                raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
          
            # å°†ç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°è¯·æ±‚
            request.state.user = payload
          
        except jwt.ExpiredSignatureError:
            raise HTTPException(status_code=401, detail="Tokenå·²è¿‡æœŸ")
        except jwt.InvalidTokenError:
            raise HTTPException(status_code=401, detail="æ— æ•ˆToken")
      
        return await call_next(request)
  
    def _check_permission(self, payload: Dict, request: Request) -> bool:
        """æ£€æŸ¥æƒé™"""
        user_role = payload.get("role", "viewer")
        required_role = self._get_required_role(request)
      
        # è§’è‰²æƒé™æ˜ å°„
        role_hierarchy = {
            "admin": ["admin", "manager", "engineer", "viewer"],
            "manager": ["manager", "engineer", "viewer"],
            "engineer": ["engineer", "viewer"],
            "viewer": ["viewer"]
        }
      
        return required_role in role_hierarchy.get(user_role, [])

# RBACæƒé™æ§åˆ¶
class RBACPermission:
    """RBACæƒé™æ§åˆ¶"""
  
    PERMISSIONS = {
        # è§’è‰²: [æƒé™åˆ—è¡¨]
        "admin": [
            "user:create", "user:read", "user:update", "user:delete",
            "project:create", "project:read", "project:update", "project:delete",
            "document:create", "document:read", "document:update", "document:delete",
            "model:train", "model:deploy", "system:manage"
        ],
        "manager": [
            "user:read",
            "project:create", "project:read", "project:update",
            "document:create", "document:read", "document:update",
            "model:read"
        ],
        "engineer": [
            "project:read",
            "document:create", "document:read", "document:update",
            "review:create", "review:read", "review:update"
        ],
        "viewer": [
            "project:read",
            "document:read",
            "review:read"
        ]
    }
```

## 4. æŠ€æœ¯é€‰å‹

### 4.1 å¼€å‘æ¡†æ¶

| ç»„ä»¶                 | æŠ€æœ¯æ ˆ                | ç‰ˆæœ¬     | é€‰å‹ç†ç”±                         |
| -------------------- | --------------------- | -------- | -------------------------------- |
| **åç«¯æ¡†æ¶**   | FastAPI               | 0.104+   | é«˜æ€§èƒ½ï¼Œå¼‚æ­¥æ”¯æŒå¥½ï¼Œè‡ªåŠ¨æ–‡æ¡£ç”Ÿæˆ |
| **å‰ç«¯æ¡†æ¶**   | React + TypeScript    | 18.2+    | ç”Ÿæ€ä¸°å¯Œï¼Œç±»å‹å®‰å…¨ï¼Œç¤¾åŒºæ´»è·ƒ     |
| **ç§»åŠ¨ç«¯**     | React Native          | 0.72+    | è·¨å¹³å°ï¼Œä»£ç å¤ç”¨ç‡é«˜             |
| **æ™ºèƒ½ä½“æ¡†æ¶** | LangChain + LangGraph | 0.0.346+ | æ™ºèƒ½ä½“å¼€å‘æ ‡å‡†ï¼Œç”Ÿæ€å®Œå–„         |

### 4.2 AIæ¨¡å‹

| æ¨¡å‹ç±»å‹           | é€‰å‹æ–¹æ¡ˆ          | éƒ¨ç½²æ–¹å¼    | å¤‡æ³¨                     |
| ------------------ | ----------------- | ----------- | ------------------------ |
| **OCR**      | PaddleOCR         | å®¹å™¨åŒ–éƒ¨ç½²  | ä¸­æ–‡è¯†åˆ«æ•ˆæœå¥½ï¼Œå¼€æºå…è´¹ |
| **å¤šæ¨¡æ€**   | Qwen-VL           | æœ¬åœ°GPUéƒ¨ç½² | ä¸­æ–‡æ”¯æŒå¥½ï¼Œå¯å•†ç”¨       |
| **é¢†åŸŸNER**  | BERTå¾®è°ƒ          | å®¹å™¨åŒ–éƒ¨ç½²  | é’ˆå¯¹æ–½å·¥é¢†åŸŸä¼˜åŒ–         |
| **LLM**      | Qwen-72B         | æœ¬åœ°GPUéƒ¨ç½² | ä¸­æ–‡æ”¯æŒå¥½ï¼Œå¯å•†ç”¨       |

### 4.3 åŸºç¡€è®¾æ–½

| ç»„ä»¶               | é€‰å‹                 | éƒ¨ç½²æ¨¡å¼ | è¯´æ˜               |
| ------------------ | -------------------- | -------- | ------------------ |
| **å®¹å™¨ç¼–æ’** | Kubernetes           | è‡ªå»ºé›†ç¾¤ | ç”Ÿäº§ç¯å¢ƒæ¨è       |
| **æœåŠ¡ç½‘æ ¼** | Istio                | å¯é€‰     | æµé‡ç®¡ç†ï¼Œå¯è§‚æµ‹æ€§ |
| **CI/CD**    | GitLab CI            | è‡ªå»º     | é›†æˆåº¦å¥½ï¼ŒåŠŸèƒ½å®Œå–„ |
| **ç›‘æ§å‘Šè­¦** | Prometheus + Grafana | è‡ªå»º     | ç›‘æ§å‘Šè­¦ä¸€ä½“åŒ–     |

### 4.4 æ•°æ®å­˜å‚¨

| å­˜å‚¨ç±»å‹             | æŠ€æœ¯é€‰å‹          | ç”¨é€”       | å®¹é‡é¢„ä¼° |
| -------------------- | ----------------- | ---------- | -------- |
| **å…³ç³»å‹**     | PostgreSQL 14     | ä¸šåŠ¡æ•°æ®   | 500GB/å¹´ |
| **ç¼“å­˜**       | Redis 7.0         | ä¼šè¯ç¼“å­˜   | 16GBå†…å­˜ |
| **å¯¹è±¡å­˜å‚¨**   | MinIO             | æ–‡ä»¶å­˜å‚¨   | 2TB/å¹´   |
| **æœç´¢å¼•æ“**   | Elasticsearch 8.0 | æ—¥å¿—æœç´¢   | 200GB/å¹´ |
| **å‘é‡æ•°æ®åº“** | Chroma/Milvus     | ç›¸ä¼¼æ€§æœç´¢ | 100GB/å¹´ |

## 5. æ€§èƒ½ä¸æ‰©å±•æ€§

### 5.1 æ€§èƒ½æŒ‡æ ‡

| åœºæ™¯                 | QPS | å“åº”æ—¶é—´ | æˆåŠŸç‡ |
| -------------------- | --- | -------- | ------ |
| **å•æ–‡ä»¶ä¸Šä¼ ** | 10  | <5ç§’     | 99.9%  |
| **å•æ–‡ä»¶è¯†åˆ«** | 5   | <30ç§’    | 99%    |
| **æ‰¹é‡å¤„ç†**   | 2   | <5åˆ†é’Ÿ   | 98%    |
| **æ™ºèƒ½æŸ¥è¯¢**   | 20  | <3ç§’     | 99%    |

### 5.2 æ‰©å±•æ–¹æ¡ˆ

```yaml
# æ°´å¹³æ‰©å±•ç­–ç•¥
scaling_strategy:
  api_servers:
    min_replicas: 3
    max_replicas: 10
    metrics:
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 70
  
  ai_services:
    min_replicas: 2
    max_replicas: 5
    metrics:
      - type: Pods
        pods:
          metric:
            name: processing_queue_length
          target:
            type: AverageValue
            averageValue: 100
  
  # æ•°æ®åº“åˆ†ç‰‡ç­–ç•¥
  database_sharding:
    strategy: "range_based"
    shard_key: "project_id"
    shards: 4
    migration: "online"
```

### 5.3 å®¹ç¾æ–¹æ¡ˆ

```yaml
# å¤šå¯ç”¨åŒºéƒ¨ç½²
deployment_zones:
  primary_zone: "cn-beijing-a"
  standby_zone: "cn-beijing-b"
  
  # æ•°æ®åŒæ­¥
  data_sync:
    postgres: "é€»è¾‘å¤åˆ¶ + WALå½’æ¡£"
    redis: "ä¸»ä»å¤åˆ¶ + å“¨å…µ"
    minio: "è·¨åŒºå¤åˆ¶"
  
  # æ•…éšœåˆ‡æ¢
  failover:
    detection_interval: "30s"
    failover_timeout: "5m"
    auto_failover: true
```

## 6. éƒ¨ç½²ä¸è¿ç»´

### 6.1 éƒ¨ç½²æµç¨‹

```bash
# 1. ä»£ç æ„å»º
docker build -t construction-ai-api:latest -f Dockerfile.api .
docker build -t construction-ai-ocr:latest -f Dockerfile.ocr .
docker build -t construction-ai-vlm:latest -f Dockerfile.vlm .
docker build -t construction-ai-llm:latest -f Dockerfile.llm .

# 2. æ¨é€é•œåƒ
docker push registry.example.com/construction-ai-api:latest
docker push registry.example.com/construction-ai-ocr:latest
docker push registry.example.com/construction-ai-vlm:latest
docker push registry.example.com/construction-ai-llm:latest

# 3. éƒ¨ç½²åˆ°K8s
kubectl apply -f k8s/namespace.yaml
kubectl apply -f k8s/configs/
kubectl apply -f k8s/database/
kubectl apply -f k8s/services/
kubectl apply -f k8s/ingress/

# 4. æ»šåŠ¨æ›´æ–°
kubectl rollout restart deployment/construction-ai-api
kubectl rollout status deployment/construction-ai-api
```

### 6.2 ç›‘æ§ä½“ç³»

```yaml
# ç›‘æ§æŒ‡æ ‡
metrics:
  # ä¸šåŠ¡æŒ‡æ ‡
  - name: documents_processed_total
    type: counter
    labels: [project_id, status]
  
  - name: processing_duration_seconds
    type: histogram
    buckets: [0.1, 0.5, 1, 5, 10, 30, 60]
  
  - name: accuracy_rate
    type: gauge
    labels: [field_type]
  
  # ç³»ç»ŸæŒ‡æ ‡
  - name: cpu_usage_percent
    type: gauge
  
  - name: memory_usage_bytes
    type: gauge
  
  - name: active_connections
    type: gauge
  
  # AIæ¨¡å‹æŒ‡æ ‡
  - name: model_inference_duration
    type: histogram
  
  - name: model_cache_hit_rate
    type: gauge
```

## 7. æˆæœ¬ä¼°ç®—

### 7.1 ç¡¬ä»¶æˆæœ¬

| èµ„æº                 | è§„æ ¼             | æ•°é‡ | å•ä»·        | æœˆæˆæœ¬                | å¤‡æ³¨     |
| -------------------- | ---------------- | ---- | ----------- | --------------------- | -------- |
| **GPUæœåŠ¡å™¨**  | 8æ ¸32G + A10Ã—2  | 2å°  | Â¥15,000/æœˆ | Â¥30,000              | AIè®¡ç®—   |
| **CPUæœåŠ¡å™¨**  | 16æ ¸32G          | 4å°  | Â¥5,000/æœˆ  | Â¥20,000              | åº”ç”¨æœåŠ¡ |
| **å­˜å‚¨æœåŠ¡å™¨** | 32æ ¸64G + 10TÃ—4 | 2å°  | Â¥8,000/æœˆ  | Â¥16,000              | æ•°æ®å­˜å‚¨ |
| **ç½‘ç»œè®¾å¤‡**   | åƒå…†äº¤æ¢æœº       | 1å¥—  | Â¥2,000/æœˆ  | Â¥2,000               | ç½‘ç»œè¿æ¥ |
| **åˆè®¡**       | -                | -    | -           | **Â¥68,000/æœˆ** | -        |

### 7.2 è½¯ä»¶æˆæœ¬

| è½¯ä»¶               | ç±»å‹                       | æˆæœ¬             | å¤‡æ³¨     |
| ------------------ | -------------------------- | ---------------- | -------- |
| **æ“ä½œç³»ç»Ÿ** | Ubuntu Server              | å…è´¹             | å¼€æº     |
| **æ•°æ®åº“**   | PostgreSQL                 | å…è´¹             | å¼€æº     |
| **ä¸­é—´ä»¶**   | Redis, RabbitMQ            | å…è´¹             | å¼€æº     |
| **AIæ¡†æ¶**   | PaddlePaddle, Transformers | å…è´¹             | å¼€æº     |
| **ç›‘æ§ç³»ç»Ÿ** | Prometheus, Grafana        | å…è´¹             | å¼€æº     |
| **åˆè®¡**     | -                          | **Â¥0/æœˆ** | å…¨éƒ¨å¼€æº |

### 7.3 äººåŠ›æˆæœ¬

| è§’è‰²                 | äººæ•° | æœˆè–ª     | æœˆæˆæœ¬                 | å¤‡æ³¨ |
| -------------------- | ---- | -------- | ---------------------- | ---- |
| **åç«¯å¼€å‘**   | 2äºº  | Â¥25,000 | Â¥50,000               |      |
| **å‰ç«¯å¼€å‘**   | 1äºº  | Â¥20,000 | Â¥20,000               |      |
| **ç®—æ³•å·¥ç¨‹å¸ˆ** | 2äºº  | Â¥30,000 | Â¥60,000               |      |
| **è¿ç»´å·¥ç¨‹å¸ˆ** | 1äºº  | Â¥20,000 | Â¥20,000               | å…¼èŒ |
| **æµ‹è¯•å·¥ç¨‹å¸ˆ** | 1äºº  | Â¥18,000 | Â¥18,000               | å…¼èŒ |
| **åˆè®¡**       | 7äºº  | -        | **Â¥168,000/æœˆ** |      |

### 7.4 æ€»æˆæœ¬

| ç±»åˆ«               | æœˆæˆæœ¬                 | å¹´æˆæœ¬                   | å¤‡æ³¨         |
| ------------------ | ---------------------- | ------------------------ | ------------ |
| **ç¡¬ä»¶æˆæœ¬** | Â¥68,000               | Â¥816,000                |              |
| **è½¯ä»¶æˆæœ¬** | Â¥0                    | Â¥0                       |              |
| **äººåŠ›æˆæœ¬** | Â¥168,000              | Â¥2,016,000              |              |
| **å…¶ä»–æˆæœ¬** | Â¥20,000               | Â¥240,000                | ç”µè´¹ã€å¸¦å®½ç­‰ |
| **åˆè®¡**     | **Â¥256,000/æœˆ** | **Â¥3,072,000/å¹´** |              |

---

**æ¶æ„å®¡æ‰¹**

| è§’è‰²       | å§“å | éƒ¨é—¨       | ç­¾å­— | æ—¥æœŸ       |
| ---------- | ---- | ---------- | ---- | ---------- |
| æ¶æ„å¸ˆ     | å¼ ä¸‰ | æŠ€æœ¯æ¶æ„éƒ¨ |      | 2026-01-15 |
| æŠ€æœ¯è´Ÿè´£äºº | æå›› | æŠ€æœ¯å§”å‘˜ä¼š |      | 2026-01-15 |
| CTO        | ç‹äº” | CTOåŠå…¬å®¤  |      | 2026-01-15 |
